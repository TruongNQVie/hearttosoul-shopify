<!-- Cart Drawer Shell ‚Äî Content is rendered dynamically via JavaScript -->
<div class="cart-drawer" id="cart-drawer">
  <div class="cart-drawer__overlay" data-cart-close></div>
  <div class="cart-drawer__panel">
    <div class="cart-drawer__header">
      <div>
        <h3>Shopping Cart</h3>
        <span class="cart-drawer__count" id="cart-drawer-count">0 items</span>
      </div>
      <button class="cart-drawer__close" data-cart-close aria-label="Close cart">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <!-- Items container ‚Äî filled by JS -->
    <div class="cart-drawer__body" id="cart-drawer-body">
      <div class="cart-drawer__empty">
        <div style="font-size: 48px; margin-bottom: 16px;">üõçÔ∏è</div>
        <p style="font-size:18px; margin-bottom:8px; font-family: var(--font-heading);">Your cart is empty</p>
        <p style="color: var(--color-text-muted); font-size: 14px;">Discover something special for your loved ones.</p>
        <a href="{{ routes.all_products_collection_url }}" class="cart-drawer__continue-btn" style="margin-top:20px;" data-cart-close>CONTINUE SHOPPING</a>
      </div>
    </div>
    <!-- Footer ‚Äî filled by JS -->
    <div class="cart-drawer__footer" id="cart-drawer-footer" style="display: none;">
      <div class="cart-drawer__subtotal">
        <span>Total</span>
        <span class="cart-drawer__total-price" id="cart-drawer-total">$0.00</span>
      </div>
      <a href="/checkout" class="cart-drawer__checkout-btn" id="cart-drawer-checkout-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        CHECKOUT ‚Äî <span id="cart-drawer-checkout-total">$0.00</span>
      </a>
      <p class="cart-drawer__secure-note">üîí Secure checkout powered by Shopify</p>
    </div>
  </div>
</div>

<script>
// ===== Cart Drawer ‚Äî Fully AJAX-Driven =====
(function() {
  const drawer = document.getElementById('cart-drawer');
  const body = document.getElementById('cart-drawer-body');
  const footer = document.getElementById('cart-drawer-footer');
  const countEl = document.getElementById('cart-drawer-count');
  const totalEl = document.getElementById('cart-drawer-total');
  const checkoutTotalEl = document.getElementById('cart-drawer-checkout-total');

  // Format cents to money
  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  // Render cart items from /cart.js data
  window.renderCartDrawer = function() {
    fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        // Update header count
        countEl.textContent = cart.item_count + ' ' + (cart.item_count === 1 ? 'item' : 'items');

        // Update cart count badges everywhere
        document.querySelectorAll('[data-cart-count]').forEach(b => {
          b.textContent = cart.item_count;
          b.style.display = cart.item_count > 0 ? '' : 'none';
        });

        if (cart.item_count === 0) {
          // Show empty state
          body.innerHTML = `
            <div class="cart-drawer__empty">
              <div style="font-size: 48px; margin-bottom: 16px;">üõçÔ∏è</div>
              <p style="font-size:18px; margin-bottom:8px; font-family: var(--font-heading);">Your cart is empty</p>
              <p style="color: var(--color-text-muted); font-size: 14px;">Discover something special for your loved ones.</p>
              <button class="cart-drawer__continue-btn" style="margin-top:20px;" data-cart-close onclick="closeCartDrawer()">CONTINUE SHOPPING</button>
            </div>
          `;
          footer.style.display = 'none';
          return;
        }

        // Build items HTML
        let html = '';
        cart.items.forEach(item => {
          const imgSrc = item.image ? item.image.replace(/(\.\w+)$/, '_160x$1') : '';
          const variantTitle = (item.variant_title && item.variant_title !== 'Default Title') ? item.variant_title : '';
          html += `
            <div class="cart-drawer__item">
              <div class="cart-drawer__item-img">
                ${imgSrc ? `<img src="${imgSrc}" alt="${item.title}">` : ''}
              </div>
              <div class="cart-drawer__item-info">
                <p class="cart-drawer__item-title">${item.product_title}</p>
                ${variantTitle ? `<p class="cart-drawer__item-variant">${variantTitle}</p>` : ''}
                <p class="cart-drawer__item-price">${formatMoney(item.final_line_price)}</p>
                <div class="cart-drawer__item-qty">
                  <button class="cart-qty-btn" onclick="updateCartItem('${item.key}', ${item.quantity - 1})">‚àí</button>
                  <span class="cart-qty-num">${item.quantity}</span>
                  <button class="cart-qty-btn" onclick="updateCartItem('${item.key}', ${item.quantity + 1})">+</button>
                </div>
              </div>
              <button class="cart-drawer__item-remove" onclick="updateCartItem('${item.key}', 0)" aria-label="Remove">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
              </button>
            </div>
          `;
        });
        body.innerHTML = html;

        // Update footer
        footer.style.display = '';
        totalEl.textContent = formatMoney(cart.total_price);
        checkoutTotalEl.textContent = formatMoney(cart.total_price);
      })
      .catch(err => console.error('Cart fetch error:', err));
  };

  // Update a cart item quantity (also handles remove when qty=0)
  window.updateCartItem = function(key, quantity) {
    fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: key, quantity: Math.max(0, quantity) })
    })
    .then(r => r.json())
    .then(() => {
      // Re-render drawer with fresh data
      renderCartDrawer();
    })
    .catch(err => console.error('Cart update error:', err));
  };

  // Open cart drawer
  window.openCartDrawer = function() {
    renderCartDrawer();
    drawer.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  };

  // Close cart drawer
  window.closeCartDrawer = function() {
    drawer.classList.remove('is-open');
    document.body.style.overflow = '';
  };

  // Close button & overlay listeners
  document.querySelectorAll('[data-cart-close]').forEach(el => {
    el.addEventListener('click', closeCartDrawer);
  });

  // Cart icon in header opens drawer instead of navigating
  document.querySelectorAll('[data-cart-toggle]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      openCartDrawer();
    });
  });
})();
</script>
