<!-- Cart Drawer Shell ‚Äî Content rendered dynamically via JavaScript -->
<div class="cart-drawer" id="cart-drawer">
  <div class="cart-drawer__overlay" data-cart-close></div>
  <div class="cart-drawer__panel">
    <div class="cart-drawer__header">
      <div>
        <h3>Shopping Cart</h3>
        <span class="cart-drawer__count" id="cart-drawer-count">0 items</span>
      </div>
      <button class="cart-drawer__close" data-cart-close aria-label="Close cart">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div class="cart-drawer__body" id="cart-drawer-body">
      <div class="cart-drawer__loading" id="cart-drawer-loading">
        <div class="cdraw-skeleton"><div class="cdraw-skeleton__img"></div><div class="cdraw-skeleton__lines"><div class="cdraw-skeleton__line" style="width:80%"></div><div class="cdraw-skeleton__line" style="width:50%"></div><div class="cdraw-skeleton__line" style="width:30%"></div></div></div>
        <div class="cdraw-skeleton"><div class="cdraw-skeleton__img"></div><div class="cdraw-skeleton__lines"><div class="cdraw-skeleton__line" style="width:70%"></div><div class="cdraw-skeleton__line" style="width:40%"></div><div class="cdraw-skeleton__line" style="width:35%"></div></div></div>
      </div>
    </div>
    <div class="cart-drawer__footer" id="cart-drawer-footer" style="display: none;">
      <!-- Order Protection -->
      <label class="cdraw-protect">
        <div class="cdraw-protect__info">
          <div class="cdraw-protect__title">PROTECT YOUR ORDER</div>
          <div class="cdraw-protect__desc">From Loss, Damage & Theft for only <span class="cdraw-protect__price">$4.20</span></div>
          <div style="font-size:12px; margin-top:6px; font-weight:500;">Yes, protect my order please!</div>
        </div>
        <input type="checkbox" style="display:none;" onchange="this.parentElement.classList.toggle('active', this.checked)">
        <div class="cdraw-protect__toggle"></div>
      </label>

      <div class="cart-drawer__subtotal">
        <span>Total:</span>
        <span class="cart-drawer__total-price" id="cart-drawer-total">$0.00</span>
      </div>
      
      <a href="/checkout" class="cart-drawer__checkout-btn" id="cart-drawer-checkout-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        PROCEED TO CHECKOUT ‚Äî <span id="cart-drawer-checkout-total">$0.00</span>
      </a>
      
      <div class="cdraw-afterpay-msg">or 4 payments of <strong id="cdraw-afterpay-amt">$0.00</strong> with <span class="afterpay-logo">afterpay ‚úåÔ∏è</span> ‚ìò</div>

      <!-- Payment Icons -->
      <div class="cdraw-payments">
        <span class="cdraw-payment-icon" title="Visa"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#1A1F71"/><text x="24" y="20" text-anchor="middle" fill="#FFFFFF" font-size="11" font-weight="700" font-family="Arial">VISA</text></svg></span>
        <span class="cdraw-payment-icon" title="Mastercard"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#252525"/><circle cx="19" cy="16" r="9" fill="#EB001B"/><circle cx="29" cy="16" r="9" fill="#F79E1B"/><path d="M24 9.5a9 9 0 0 1 0 13" fill="#FF5F00"/></svg></span>
        <span class="cdraw-payment-icon" title="American Express"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#006FCF"/><text x="24" y="18" text-anchor="middle" fill="#FFFFFF" font-size="7" font-weight="700" font-family="Arial">AMEX</text></svg></span>
        <span class="cdraw-payment-icon" title="Discover"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#FF6600"/><text x="24" y="18" text-anchor="middle" fill="#FFFFFF" font-size="7" font-weight="700" font-family="Arial">DISCOVER</text></svg></span>
        <span class="cdraw-payment-icon" title="Apple Pay"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#000000"/><text x="24" y="19" text-anchor="middle" fill="#FFFFFF" font-size="8" font-weight="500" font-family="Arial"> Pay</text></svg></span>
        <span class="cdraw-payment-icon" title="PayPal"><svg viewBox="0 0 48 32"><rect width="48" height="32" rx="4" fill="#003087"/><text x="24" y="18" text-anchor="middle" fill="#FFFFFF" font-size="8" font-weight="700" font-family="Arial">PayPal</text></svg></span>
      </div>

      <!-- Trust Badges -->
      <div class="cdraw-trust">
        <div class="cdraw-trust__item">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cdraw-trust__icon"><path d="M21 2l-2 2H5L3 2v8c0 6 5 12 9 12s9-6 9-12V2z"/><polyline points="9 12 11 14 15 10"/></svg>
          <span class="cdraw-trust__text">100% Secure<br>Checkout</span>
        </div>
        <div class="cdraw-trust__item">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cdraw-trust__icon"><rect x="3" y="6" width="18" height="12" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M2 10h1M2 14h1M21 10h1M21 14h1"/></svg>
          <span class="cdraw-trust__text">60-Day Money<br>Back Guarantee</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Elements added for Conversion */
.mt-12 { margin-top: 12px; }
.mb-12 { margin-bottom: 12px; }
.cdraw-promo { display: flex; gap: 12px; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid var(--color-border); }
.cdraw-promo__img-wrap { position: relative; width: 70px; height: 70px; flex-shrink: 0; background: var(--color-bg-warm); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.cdraw-promo__badge { position: absolute; top: 0; left: 0; background: var(--color-success); color: white; font-size: 8px; font-weight: 700; padding: 2px 6px; border-bottom-right-radius: 6px; z-index: 2; }
.cdraw-promo__text { flex: 1; }
.cdraw-promo__title { font-weight: 700; font-size: 13px; color: #111; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
.cdraw-promo__desc { font-size: 11px; color: var(--color-text-muted); line-height: 1.3; }
.cdraw-promo__price { font-size: 12px; font-weight: 700; color: var(--color-success); margin-top: 4px; }

.cdraw-upsell { border: 1px solid var(--color-primary); border-radius: 8px; overflow: hidden; }
.cdraw-upsell__header { background: var(--color-primary); color: white; padding: 6px 14px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.cdraw-upsell__body { padding: 12px; display: flex; gap: 12px; background: white; }
.cdraw-upsell__img { width: 64px; height: 64px; border-radius: 6px; border: 1px solid var(--color-border); object-fit: cover; flex-shrink: 0; }
.cdraw-upsell__info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.cdraw-upsell__title { font-size: 12px; font-weight: 600; line-height: 1.3; color: var(--color-text); margin-bottom: 2px; }
.cdraw-upsell__price { font-size: 12px; font-weight: 700; color: var(--color-text); margin-bottom: 8px;}
.cdraw-upsell__add { 
  background: var(--color-success); color: white; border: none; padding: 6px 12px; 
  border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; 
  text-transform: uppercase; width: 100%; transition: background 0.2s;
}
.cdraw-upsell__add:hover { background: #2e7d32; }

.cdraw-protect { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
.cdraw-protect__title { font-size: 11px; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px; }
.cdraw-protect__desc { font-size: 11px; color: var(--color-text-muted); margin-top: 2px; }
.cdraw-protect__price { font-weight: 700; color: var(--color-success); }
.cdraw-protect__toggle { position: relative; width: 36px; height: 20px; background: #e0e0e0; border-radius: 20px; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
.cdraw-protect__toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: left 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.cdraw-protect.active .cdraw-protect__toggle { background: var(--color-success); }
.cdraw-protect.active .cdraw-protect__toggle::after { left: 18px; }

.cdraw-afterpay-msg { text-align: center; font-size: 10px; color: var(--color-text-muted); margin-top: 12px; }
.afterpay-logo { font-weight: 800; color: #b2fce4; background: #000; padding: 1px 4px; border-radius: 2px; font-size: 9px; }
.cdraw-payments { display: flex; justify-content: center; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
.cdraw-payment-icon { width: 30px; height: 20px; border-radius: 3px; overflow: hidden; display: inline-flex; border: none; }
.cdraw-payment-icon svg { width: 100%; height: 100%; }

.cdraw-trust { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 0; }
.cdraw-trust__item { background: var(--color-primary); color: white; padding: 10px 6px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
.cdraw-trust__icon { opacity: 0.9; }
.cdraw-trust__text { font-size: 11px; font-weight: 600; line-height: 1.2; }

/* Tighter Footer Layout and Prominent Checkout */
.cart-drawer__subtotal { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; font-size: 16px; font-weight: 700; color: #111; }
.cart-drawer__total-price { font-size: 20px; font-weight: 800; }
.cart-drawer__checkout-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: var(--color-primary); color: white; border-radius: 40px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(157,95,27,0.2); text-decoration: none; }
.cart-drawer__checkout-btn:hover { background: var(--color-primary-dark); transform: translateY(-2px); }
</style>

<script>
(function() {
  const drawer = document.getElementById('cart-drawer');
  const bodyEl = document.getElementById('cart-drawer-body');
  const footer = document.getElementById('cart-drawer-footer');
  const countEl = document.getElementById('cart-drawer-count');
  const totalEl = document.getElementById('cart-drawer-total');
  const checkoutTotalEl = document.getElementById('cart-drawer-checkout-total');

  // Local cart state for optimistic updates
  let cartState = null;
  let isLoading = false;

  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  // Build the drawer HTML from cart state
  function buildDrawerHTML(cart) {
    if (!cart || cart.item_count === 0) {
      footer.style.display = 'none';
      return `
        <div class="cart-drawer__empty">
          <div style="font-size:48px;margin-bottom:16px">üõçÔ∏è</div>
          <p style="font-size:18px;margin-bottom:8px;font-family:var(--font-heading)">Your cart is empty</p>
          <p style="color:var(--color-text-muted);font-size:14px">Discover something special for your loved ones.</p>
          <button onclick="closeCartDrawer()" style="margin-top:24px;background:var(--color-primary);color:white;border:none;padding:12px 24px;border-radius:40px;font-weight:700;font-size:14px;cursor:pointer">CONTINUE SHOPPING</button>
        </div>`;
    }

    footer.style.display = 'block';

    const isProtectActive = document.querySelector('.cdraw-protect') && document.querySelector('.cdraw-protect').classList.contains('active');
    const protectPrice = isProtectActive ? 420 : 0;
    const computedTotal = cart.total_price + protectPrice;

    totalEl.textContent = formatMoney(computedTotal);
    checkoutTotalEl.textContent = formatMoney(computedTotal);
    
    const afterpayAmt = document.getElementById('cdraw-afterpay-amt');
    if (afterpayAmt) afterpayAmt.textContent = formatMoney(computedTotal / 4);
    countEl.textContent = cart.item_count + (cart.item_count === 1 ? ' item' : ' items');

    // Update header badges
    document.querySelectorAll('[data-cart-count]').forEach(b => {
      b.textContent = cart.item_count;
      b.style.display = cart.item_count > 0 ? '' : 'none';
    });

    const itemsHTML = cart.items.map(item => {
      const imgSrc = item.image ? item.image.replace(/(\.\w+)(\?.*)$/, '_160x$1$2').replace(/(\.\w+)$/, '_160x$1') : '';
      const variant = (item.variant_title && item.variant_title !== 'Default Title') ? item.variant_title : '';
      return `
        <div class="cdraw-item" data-key="${item.key}">
          <div class="cdraw-item__img">
            ${imgSrc ? `<img src="${imgSrc}" alt="" loading="lazy">` : '<div style="width:100%;height:100%;background:var(--color-bg-warm);display:flex;align-items:center;justify-content:center;font-size:20px">üíé</div>'}
          </div>
          <div class="cdraw-item__body">
            <div class="cdraw-item__top">
              <div class="cdraw-item__meta">
                <p class="cdraw-item__title">${item.product_title}</p>
                ${variant ? `<p class="cdraw-item__variant">${variant}</p>` : ''}
                <p class="cdraw-item__price">${formatMoney(item.final_price)}</p>
              </div>
              <button class="cdraw-item__delete" onclick="updateCartItem('${item.key}', 0)" aria-label="Remove item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
              </button>
            </div>
            <div class="cdraw-item__bottom">
              <div class="cdraw-item__qty">
                <button class="cdraw-item__qty-btn" onclick="updateCartItem('${item.key}', ${item.quantity - 1})">‚àí</button>
                <span class="cdraw-item__qty-num" id="qty-${item.key}">${item.quantity}</span>
                <button class="cdraw-item__qty-btn" onclick="updateCartItem('${item.key}', ${item.quantity + 1})">+</button>
              </div>
              <span class="cdraw-item__line-price">${formatMoney(item.final_line_price)}</span>
            </div>
          </div>
        </div>`;
    }).join('');

    const upsellsHTML = `
      <div class="cdraw-upsell mt-12 mb-12">
        <div class="cdraw-upsell__header">GIVE EXTRA LOVE</div>
        <div class="cdraw-upsell__body">
          <div class="cdraw-upsell__img" style="background:var(--color-bg-warm);display:flex;align-items:center;justify-content:center;font-size:24px;">üíé</div>
          <div class="cdraw-upsell__info">
            <div>
               <div class="cdraw-upsell__title">Add Extra Chain length (2")</div>
               <div class="cdraw-upsell__price">$9.95 <span style="text-decoration:line-through;color:#999;font-size:11px;font-weight:400;">$19.99</span></div>
            </div>
            <button class="cdraw-upsell__add" onclick="window.location='/collections/all'">ADD TO CART</button>
          </div>
        </div>
      </div>
    `;

    return itemsHTML + upsellsHTML;
  }

  // Render from current state
  function renderFromState() {
    const loadingEl = document.getElementById('cart-drawer-loading');
    if (loadingEl) loadingEl.style.display = 'none';
    bodyEl.innerHTML = buildDrawerHTML(cartState);
  }

  // Show loading skeleton
  function showLoading() {
    const loadingEl = document.getElementById('cart-drawer-loading');
    if (loadingEl) {
      loadingEl.style.display = '';
      bodyEl.innerHTML = '';
      bodyEl.appendChild(loadingEl);
    }
  }

  // Fetch fresh cart data and render (returns a Promise)
  window.renderCartDrawer = function() {
    return fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        cartState = cart;
        renderFromState();
        return cart;
      })
      .catch(err => console.error('Cart fetch error:', err));
  };

  // Optimistic update: immediately change local state, render, then sync with server
  window.updateCartItem = function(key, quantity) {
    quantity = Math.max(0, quantity);

    // Optimistic: update local state instantly
    if (cartState) {
      if (quantity === 0) {
        cartState.items = cartState.items.filter(i => i.key !== key);
      } else {
        const item = cartState.items.find(i => i.key === key);
        if (item) {
          const pricePer = item.final_price;
          item.quantity = quantity;
          item.final_line_price = pricePer * quantity;
        }
      }
      // Recalculate totals
      cartState.item_count = cartState.items.reduce((s, i) => s + i.quantity, 0);
      cartState.total_price = cartState.items.reduce((s, i) => s + i.final_line_price, 0);
      renderFromState();
    }

    // Sync with server in background
    fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: key, quantity: quantity })
    })
    .then(r => r.json())
    .then(cart => {
      // Sync state with server truth (corrects any discrepancies)
      cartState = cart;
      renderFromState();
    })
    .catch(err => console.error('Cart update error:', err));
  };

  // Open ‚Äî fetch data FIRST, then open drawer
  window.openCartDrawer = function() {
    // If we already have state, show it immediately and refresh in bg
    if (cartState && cartState.items) {
      renderFromState();
      drawer.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      // Still refresh from server to catch discrepancies
      renderCartDrawer();
    } else {
      // No local state yet ‚Äî show loading, fetch, then reveal
      showLoading();
      drawer.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      renderCartDrawer();
    }
  };

  // Close
  window.closeCartDrawer = function() {
    drawer.classList.remove('is-open');
    document.body.style.overflow = '';
  };

  // Event listeners
  document.querySelectorAll('[data-cart-close]').forEach(el => {
    el.addEventListener('click', closeCartDrawer);
  });
  document.querySelectorAll('[data-cart-toggle]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      openCartDrawer();
    });
  });

  // Pre-seed cart state on page load (via Liquid) to avoid flash
  cartState = {{ cart | json }};
  renderFromState();

  // Handle Order Protection Toggle
  const protectToggle = document.querySelector('.cdraw-protect input[type="checkbox"]');
  if(protectToggle) {
    protectToggle.addEventListener('change', function() {
      // Re-render visually (adds $4.20)
      renderFromState();
    });
  }
})();
</script>
